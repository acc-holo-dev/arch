# Installation Architecture

## Overview
Установщик построен из отдельных стадий, которые координирует тонкая точка входа `bin/install.sh`. Аргументы CLI отвечают за логирование, dry-run и выбор конкретной стадии. Все настройки пакетов и сервисов собраны в корневом `config.sh`.

```
┌─────────────┐      ┌──────────┐      ┌────────┐      ┌────────┐      ┌────────────┐      ┌──────┐      ┌────┐
│ bin/install │ ───▶ │ preflight│ ───▶ │  disk  │ ───▶ │ system │ ───▶ │    apps    │ ───▶ │ post │ ───▶ │ aur│
└─────────────┘      └──────────┘      └────────┘      └────────┘      └────────────┘      └──────┘      └────┘
```

## Flow description
1. **bin/install.sh** – Разбирает флаги (`--dry-run`, `--log-level`, `--stage`), готовит лог-файл, детектит CPU/GPU/виртуализацию и передаёт переменные окружения в модули.
2. **modules/preflight.sh** – Проверяет root, архитектуру, наличие UEFI, обязательные утилиты, синхронизирует время и ждёт сеть.
3. **modules/disk.sh** – В соответствии с `TARGET_DISK` из `config.sh` создаёт GPT, разделы, форматы и монтирует в `INSTALL_ROOT`.
4. **modules/system.sh** – Выполняет `pacstrap` базовых пакетов + microcode и драйвера GPU/гостей, генерирует `fstab`, настраивает локали/таймзону/hostname и ставит `bootctl`.
5. **modules/apps.sh** – Устанавливает пользовательские наборы пакетов (Hyprland, разработка, шрифты, gaming) согласно переключателям из `config.sh` и записывает план AUR.
6. **modules/postinstall.sh** – Создаёт пользователя, включает sudo для wheel, активирует системные сервисы из `config.sh`.
7. **modules/aur.sh** – Ставит `yay` для созданного пользователя и устанавливает AUR-пакеты (включая GPU-специфичные).

## Shared libraries
Общее поведение в `lib/`:
- `logging.sh`: уровневое логирование в консоль и файл, секции, конфигурация лог-файла.
- `errors.sh`: ловушка ошибок с выводом номера строки и пути к логу.
- `prompts.sh`: подтверждения и опросы пользователя.
- `net.sh`: `require_command`, ожидание сетевого линка, синхронизация времени.
- `hw.sh`: детект CPU/GPU/виртуализации, выбор microcode и GPU/guest пакетов.

## Диаграмма
При добавлении новых стадий обновляйте ASCII-схему выше и добавляйте краткое описание в секцию Flow description. Если вносятся новые группы пакетов, фиксируйте их в `config.sh`.
